
## ssh

```bash
# 安装
yum install SSH
apt install openssl

vim /etc/ssh/sshd_config
systemctl restart sshd

Port 22 #端口
添加一行：Port 23 #多个ssh连接端口
PasswordAuthentication no #禁用密码验证
RSAAuthentication yes #启用密钥验证
PubkeyAuthentication yes
AuthorsizedKeysFile .ssh/authorized_keys #指定公钥数据库文件


ssh localhost -p port #测试
ssh –l user –p 22 britepic.org


ssh-keygen
ssh-keygen -t rsa   # 创建一个默认密钥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com" # 创建一个默认密钥
eval "$(ssh-agent -s)"

ssh-copy-id -i ali.pub one@192.168.1.2 # 远程添加密钥

scp file host:/home/user/path
ssh -vvvv # debug模式
ssh-add ~/.ssh/id_rsa # 添加默认密钥


```

## 别名登陆

```config
vim ~/.ssh/config
>ssh 别名
Host ali  #别名
HostName 192.168.1.2 #主机名
Port            端口
User root #用户名
PreferredAuthentications publickey
IdentityFile ~/.ssh/ali #密钥文件的路径
```

## ssh 穿透内网

```bash
#ssh -NfR 远端主机listen port:远端连回时导向的主机 : 远端连回本地主机时导向主机的port 帐号@远端主机 
#外网服务器:115.159.22.131
#内网服务器：localhost

#内网命令
systemctl start ssh
ssh -v -fCNR 63095:localhost:22 root@115.159.22.131

autossh -M 5678 -NR 63095:localhost:22 root@115.159.22.131

#外网命令
ssh-keygen -t rsa
复制 .pub到内网authorized_keys
ssh -i ~/.ssh/yj_work/115_159_22_131 yj@localhost -p 63095


#反向SSH隧道,只能远端主机登陆
ssh -fN -R [远端主机port]:[远端连回时导向的主机]:[远端连回本地主机时的port] [帐号@远端主机]

yj@yj:~$ssh -fN -R 63095:localhost:22 root@118.24.189.248
root@118.24.189.248:~$netstat -nap | grep 63095
root@118.24.189.248:~$ssh -p 63095 yj@localhost

#反向SSH隧道,所有主机登陆
yj@yj:~$ssh -fN -R 118.24.189.248:63095:localhost:22 
root@118.24.189.248
其他服务器:~$ssh -p 63095 yj@118.24.189.248

#永久反向 SSH 隧道 autossh
yj@yj:~$autossh -M 10900 -fN -o "PubkeyAuthentication=yes" -o "StrictHostKeyChecking=false" -o "PasswordAuthentication=no" -o "ServerAliveInterval 60" -o "ServerAliveCountMax 3" -R 118.24.189.248:63095:localhost:22 root@118.24.189.248
#-M 10900 选项指定中继服务器上的监视端口，用于交换监视 SSH 会话的测试数据。中继服务器上的其它程序不能使用这个端口。
#-fN 选项传递给 ssh 命令，让 SSH 隧道在后台运行。
#-o XXXX 选项让 ssh：
#使用密钥验证，而不是密码验证。
#自动接受（未知）SSH 主机密钥。
#每 60 秒交换 keep-alive 消息。
#没有收到任何响应时最多发送 3 条 keep-alive 消息。

```

```bash
-1：强制使用ssh协议版本1；
-2：强制使用ssh协议版本2；
-4：强制使用IPv4地址；
-6：强制使用IPv6地址；
-A：开启认证代理连接转发功能；
-a：关闭认证代理连接转发功能；
-b：使用本机指定地址作为对应连接的源ip地址；
-C：请求压缩所有数据；
-F：指定ssh指令的配置文件；
-f：后台执行ssh指令；
-g：允许远程主机连接主机的转发端口；
-i：指定身份文件；
-l：指定连接远程服务器登录用户名；
-N：不执行远程指令；
-o：指定配置选项；
-p：指定远程服务器上的端口；
-q：静默模式；
-X：开启X11转发功能；
-x：关闭X11转发功能；
-y：开启信任X11转发功能。
```

### 安装

```bash
yum install SSH
sudo apt install openssl
systemctl restart sshd
```

### 配置

```bash
vim /etc/ssh/sshd_config

Port 22                     #端口
Port 23                     #多个ssh连接端口 添加一行

PasswordAuthentication no   #禁用密码验证
RSAAuthentication yes       #启用密钥验证
PubkeyAuthentication yes
AuthorsizedKeysFile .ssh/authorized_keys    #指定公钥数据库文件

UseDNS no                   #在最后添加下面一行,关闭 SSH 的 DNS 反解析
GSSAPIAuthentication yes    #改成 no gssapi-with-mic
GatewayPorts clientspecified || yes # 让中继服务器上的 sshd 不仅转发回环地址上的端口，还要转发外部主机的端口。这通过指定中继服务器上运行的 sshd 的 GatewayPorts 实现
PermitRootLogin no          #禁止ROOT远程SSH登录
```

### 创建服务器证书密钥

```bash
# 生成服务器端私钥
$ openssl genrsa -out server.key 4096
$ openssl genrsa -des3 -out server.key 4096 # 带密码

# 创建服务器证书的申请文件 server.csr
openssl req -new -key server.key -out server.csr
# 输出内容为：
# Enter pass phrase for root.key: ← 输入前面创建的密码
# Country Name (2 letter code) [AU]:CN ← 国家代号，中国输入CN
# State or Province Name (full name) [Some-State]:BeiJing ← 省的全名，拼音
# Locality Name (eg, city) []:BeiJing ← 市的全名，拼音
# Organization Name (eg, company) [Internet Widgits Pty Ltd]:MyCompany Corp. ← 公司英文名
# Organizational Unit Name (eg, section) []: ← 可以不输入
# Common Name (eg, YOUR name) []: ← 输入域名，如：iot.conet.com
# Email Address []:admin@mycompany.com ← 电子邮箱，可随意填
# Please enter the following ‘extra’ attributes
# to be sent with your certificate request
# A challenge password []: ← 可以不输入
# An optional company name []: ← 可以不输入
 
# 备份一份服务器密钥文件
cp server.key server.key.org
# 去除文件口令
openssl rsa -in server.key.org -out server.key
# 生成证书文件server.crt
openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt


# ssl_certificate        conf.d/key/server.crt;
# ssl_certificate_key    conf.d/key/server.key;
```

### 客户端配置

```bash
ssh_config
# 每30秒发送一次心跳检测
ServerAliveInterval 30
# 超过10次都没有成功，就主动断开与服务器的连接
ServerAliveCountMax 10
```

### 服务端配置

```bash
sudo vim /etc/ssh/sshd_config
ClientAliveInterval 30 #ClientAliveInterval表示每隔多少秒，服务器端向客户端发送心跳，是的，你没看错。
ClientAliveCountMax 6  #下面的ClientAliveInterval表示上述多少次心跳无响应之后，会认为Client已经断开。
```
